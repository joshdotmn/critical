name: RubyCritic

on:
  push:
    branches: ['**']
  pull_request:

jobs:
  rubycritic:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Run RubyCritic
        run: bundle exec rubycritic app lib --no-browser

      - name: Sanitize branch name
        id: branch
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9_-]/-/g')
          echo "name=$SAFE_BRANCH" >> $GITHUB_OUTPUT

      - name: Organize files by branch
        run: |
          mkdir -p public/${{ steps.branch.outputs.name }}
          cp -r tmp/rubycritic/* public/${{ steps.branch.outputs.name }}/

      - name: Create index page
        run: |
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>RubyCritic Reports</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0066cc; text-decoration: none; font-size: 18px; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>RubyCritic Reports by Branch</h1>
            <ul id="branches"></ul>
            <script>
              // List all branch directories
              fetch('branches.json')
                .then(r => r.json())
                .catch(() => [])
                .then(branches => {
                  const list = document.getElementById('branches');
                  if (branches.length === 0) {
                    // Fallback if branches.json doesn't exist
                    list.innerHTML = '<li>No reports available yet. Check back after first deployment.</li>';
                  } else {
                    branches.forEach(b => {
                      const li = document.createElement('li');
                      li.innerHTML = `<a href="${b}/overview.html">${b}</a>`;
                      list.appendChild(li);
                    });
                  }
                });
            </script>
          </body>
          </html>
          EOF

      - name: List branches in JSON
        run: |
          echo "[" > public/branches.json
          for dir in public/*/; do
            if [ -d "$dir" ]; then
              branch=$(basename "$dir")
              echo "  \"$branch\"," >> public/branches.json
            fi
          done
          # Remove trailing comma and close array
          sed -i '$ s/,$//' public/branches.json
          echo "]" >> public/branches.json

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        if: github.event_name == 'push'
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: critical-rubycritic
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}