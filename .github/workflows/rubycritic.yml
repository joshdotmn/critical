name: RubyCritic

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  rubycritic:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Run RubyCritic
        run: bundle exec rubycritic app lib --no-browser

      - name: Sanitize branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, use pr-NUMBER format
            BRANCH_NAME="pr-${{ github.event.pull_request.number }}"
          else
            # For pushes to main
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          fi
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9_-]/-/g')
          echo "name=$SAFE_BRANCH" >> $GITHUB_OUTPUT

      - name: Download previous deployment
        run: |
          mkdir -p public
          
          # Download branches.json to see what exists
          echo "Fetching existing branches..."
          curl -f https://critical-rubycritic.pages.dev/branches.json -o public/branches.json 2>/dev/null || echo "[]" > public/branches.json
          
          echo "=== Current branches.json ==="
          cat public/branches.json
          echo "==========================="
          
          # Parse branches and download each one using wget
          if [ -f public/branches.json ]; then
            # Read each branch name
            branches=$(cat public/branches.json | grep -o '"[^"]*"' | tr -d '"' || echo "")
          
            for branch in $branches; do
              echo "Downloading branch: $branch"
          
              # Use wget to mirror the branch directory
              wget --recursive \
                   --no-parent \
                   --no-host-directories \
                   --directory-prefix=public \
                   --reject="index.html" \
                   --level=5 \
                   --quiet \
                   "https://critical-rubycritic.pages.dev/$branch/" || echo "Failed to download $branch"
            done
          fi
          
          echo "=== Contents of public directory ==="
          ls -laR public/ | head -50
          echo "==================================="
        continue-on-error: true

      - name: Organize files by branch
        run: |
          mkdir -p public/${{ steps.branch.outputs.name }}
          cp -r tmp/rubycritic/* public/${{ steps.branch.outputs.name }}/

      - name: Create index page
        run: |
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>RubyCritic Reports</title>
            <style>
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                max-width: 800px; 
                margin: 50px auto; 
                padding: 20px;
                background: #f5f5f5;
              }
              .container {
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              h1 { 
                color: #333;
                margin-top: 0;
              }
              ul { 
                list-style: none; 
                padding: 0; 
              }
              li { 
                margin: 12px 0;
                padding: 12px;
                background: #f9f9f9;
                border-radius: 4px;
                border-left: 3px solid #0066cc;
              }
              a { 
                color: #0066cc; 
                text-decoration: none; 
                font-size: 18px;
                font-weight: 500;
              }
              a:hover { 
                text-decoration: underline; 
              }
              .branch-type {
                font-size: 14px;
                color: #666;
                margin-left: 8px;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üîç RubyCritic Reports</h1>
              <ul id="branches"></ul>
            </div>
            <script>
              fetch('branches.json')
                .then(r => r.json())
                .catch(() => [])
                .then(branches => {
                  const list = document.getElementById('branches');
                  if (branches.length === 0) {
                    list.innerHTML = '<li>No reports available yet.</li>';
                  } else {
                    // Sort: main first, then PRs
                    branches.sort((a, b) => {
                      if (a === 'main') return -1;
                      if (b === 'main') return 1;
                      return a.localeCompare(b);
                    });
          
                    branches.forEach(b => {
                      const li = document.createElement('li');
                      const type = b === 'main' ? 'üåø Main Branch' : 'üîÄ Pull Request';
                      li.innerHTML = `<a href="${b}/overview.html">${b}</a><span class="branch-type">${type}</span>`;
                      list.appendChild(li);
                    });
                  }
                });
            </script>
          </body>
          </html>
          EOF

      - name: List branches in JSON
        run: |
          echo "=== Before updating branches.json ==="
          ls -la public/
          echo "======================================"
          
          echo "[" > public/branches.json
          for dir in public/*/; do
            if [ -d "$dir" ] && [ -f "$dir/overview.html" ]; then
              branch=$(basename "$dir")
              echo "Found branch with overview.html: $branch"
              echo "  \"$branch\"," >> public/branches.json
            fi
          done
          # Remove trailing comma and close array
          sed -i '$ s/,$//' public/branches.json
          echo "]" >> public/branches.json
          
          echo "=== Final branches.json ==="
          cat public/branches.json
          echo "============================"

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: critical-rubycritic
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: main